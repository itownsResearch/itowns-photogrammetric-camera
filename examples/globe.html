<html>
    <head>
        <title>Itowns - Globe</title>

        <style type="text/css">
            #miniDiv {
                display: block;
                margin-bottom: 20px;
                margin-right: 20px;
                position: absolute;
                left: 20;
                bottom: 0;
                color: white;
            }
        </style>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="css/example.css">
        <link rel="stylesheet" type="text/css" href="css/loading_screen.css">
        <link rel="stylesheet" type="text/css" href="../../src/scene2d.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="js/GUI/dat.gui/dat.gui.min.js"></script>
        <script src="js/OrientedImageHelper.js"></script>
        
    </head>
    <body>
        <div id="viewerDiv">
            <span class="divScaleWidget"> Scale </span>
            <div id="miniDiv">
                <img id="img" src="../../data/stmichel.jpg" onmousedown="getImgCoordOnClick(event)">
                <button style="height:10px;width:20px" type="button" onclick="launchMicMac(event, document.getElementById('img').src.split('/').pop())"></button>
            </div>
        </div>
        <script src="js/GUI/GuiTools.js"></script>
        <script src="../dist/itowns.js"></script>
        <script src="js/loading_screen.js"></script>
        <script src="../dist/debug.js"></script>
        <script src="../../src/scene2d.js"></script>
        <script src="../../src/scene3dv2.js"></script>
        <script src="../../src/createCalibrationFile.js"></script>
        <script src="../../src/launchMicMac.js"></script>
       
        <script type="text/javascript">
            // # Simple Globe viewer

            // Define initial camera position  // 43.9542987,6.5115427 44.1751125,6.3516113,222m 44.1748836,6.3511125
            // var positionOnGlobe = { longitude: 2.3186303566461626, latitude: 48.86426741804917, altitude: 188.94939874485135 };
            // 42.7211829,1.8392353
            // 48.8365154,-3.3129326 ( rocher de la sentinelle)
            var positionOnGlobe = { longitude: -1.5114, latitude: 48.636, altitude: 1878.615379151888 };
            //var miniView;
            var minDistance = 10000000;
            var maxDistance = 30000000;

            var meshes = [];
            // `viewerDiv` will contain iTowns' rendering area (`<canvas>`)
            var viewerDiv = document.getElementById('viewerDiv');
            //var miniDiv = document.getElementById('miniDiv');

            // Instanciate iTowns GlobeView*
            var globeView = new itowns.GlobeView(viewerDiv, positionOnGlobe,{handleCollision: false});
            setupLoadingScreen(viewerDiv, globeView);

            //3D point number
            var ptname = 0;

            // Add one imagery layer to the scene
            // This layer is defined in a json file but it could be defined as a plain js
            // object. See Layer* for more info.
            itowns.Fetcher.json('./layers/JSONLayers/Ortho.json').then(function _(config) {
                config.source = new itowns.WMTSSource(config.source);
                var layer = new itowns.ColorLayer('Ortho', config);
                globeView.addLayer(layer).then(menuGlobe.addLayerGUI.bind(menuGlobe));
            });
            // Add two elevation layers.
            // These will deform iTowns globe geometry to represent terrain elevation.
            function addElevationLayerFromConfig(config) {
                config.source = new itowns.WMTSSource(config.source);
                var layer = new itowns.ElevationLayer(config.id, config);
                globeView.addLayer(layer).then(menuGlobe.addLayerGUI.bind(menuGlobe));
            }
            itowns.Fetcher.json('./layers/JSONLayers/WORLD_DTM.json').then(addElevationLayerFromConfig);
            itowns.Fetcher.json('./layers/JSONLayers/IGN_MNT_HIGHRES.json').then(addElevationLayerFromConfig);

            var meshes = [];
            var color = new itowns.THREE.Color();
            function altitudeBuildings(properties) {
                //console.log(properties.z_min, properties.hauteur);
                return properties.z_min - properties.hauteur;
            }

            function extrudeBuildings(properties) {
                return properties.hauteur;
            }

            function acceptFeature(properties) {
                return !!properties.hauteur;
            }

            
            function colorBuildings(properties) {
                if (properties.id.indexOf('bati_remarquable') === 0) {
                    return color.set(0x5555ff);
                } else if (properties.id.indexOf('bati_industriel') === 0) {
                    return color.set(0xff5555);
                }
                return color.set(0xeeeeee);
            }

            function modifyAppearance(mesh){

              //  mesh.material = [mesh.material,new itowns.THREE.MeshBasicMaterial({wireframe:true})];
            }

            scaler = function update(/* dt */) {
                var i;
                var mesh;
                if (meshes.length) {
                    globeView.notifyChange(globeView.camera.camera3D, true);
                }
                for (i = 0; i < meshes.length; i++) {
                    mesh = meshes[i];
                    if (mesh) {
                        mesh.scale.z = Math.min(
                            1.0, mesh.scale.z + 0.1);
                        mesh.updateMatrixWorld(true);
                    }
                }
                meshes = meshes.filter(function filter(m) { return m.scale.z < 1; });
            };

            globeView.addFrameRequester(itowns.MAIN_LOOP_EVENTS.BEFORE_RENDER, scaler);


            var wfsBuildingSource = new itowns.WFSSource({
                url: 'https://wxs.ign.fr/3ht7xcw6f7nciopo16etuqp2/geoportail/wfs?',
                version: '2.0.0',
                typeName: 'BDTOPO_BDD_WLD_WGS84G:bati_remarquable,BDTOPO_BDD_WLD_WGS84G:bati_indifferencie,BDTOPO_BDD_WLD_WGS84G:bati_industriel',
                projection: 'EPSG:4326',
                ipr: 'IGN',
                format: 'application/json',
                zoom: { min: 15, max: 15 },
              
            });

            var wfsBuildingLayer = new itowns.GeometryLayer('WFS Building', new itowns.THREE.Group(), {
                update: itowns.FeatureProcessing.update,
                convert: itowns.Feature2Mesh.convert({
                    color: colorBuildings,
                    batchId: function (property, featureId) { return featureId; },
                    altitude: altitudeBuildings,
                    extrude: extrudeBuildings }),
                onMeshCreated: function scaleZ(mesh) {
                    mesh.scale.z = 0.01;
                    meshes.push(mesh);
                    modifyAppearance(mesh);
                },
                filter: acceptFeature,
                overrideAltitudeInToZero: true,
                source: wfsBuildingSource
            });
            globeView.addLayer(wfsBuildingLayer);


            var menuGlobe = new GuiTools('menuDiv', globeView);



            // Listen for globe full initialisation event
            globeView.addEventListener(itowns.GLOBE_VIEW_EVENTS.GLOBE_INITIALIZED, function () {
                // eslint-disable-next-line no-console
                console.info('Globe initialized');
                //updateScaleWidget();
                // get 3D coordinates on mouse click
                window.addEventListener('mousedown', pickPosition, false);
                function pickPosition(event) {
                  
                    if(event.altKey){
                        // increment point number
                        ptname += 1;
                        var pickBuilding = pickingBuildings(event);

                        if(pickBuilding.z == 0){
                            // get 3D coordinates on ground
                            geoposition = globeView.controls.pickGeoPosition(new itowns.THREE.Vector2(event.pageX,event.pageY));
                            //console.log(globeView.controls.pickGeoPosition(globeView.eventToViewCoords(event.altKey)));
                            // convert coordinates to geographic system
                            let converted = geoposition.as('EPSG:4978'); 
                            coordinates = converted._values;
                            x = coordinates[0];
                            y = coordinates[1];
                            z = coordinates[2];
                        }
                        else{
                            x = pickBuilding.x, y = pickBuilding.y, z = pickBuilding.z;
                        }
                            
                        show3DPicking(x,y,z, ptname);
                        // export 3D coordinates to an xml file
                        export3Dcoord(ptname,x,y,z);
                        console.log("Nb of points picked: ", ptname);
                        
                    }
                }

                createCalib(); // We create a calibration file knowing just the image size 
            });


            // Picking on buildings
            function pickingBuildings(event) {
                var p3D = new itowns.THREE.Vector3();
                if(globeView.controls.isPaused()) {
                    var intersects = globeView.pickObjectsAt(event, 3, 'WFS Building');
                    if (intersects.length) {
                        //console.log(intersects[0].point);
                        p3D = intersects[0].point;
                    }
                }
                return p3D;
            }

/*
            globeView.controls.addEventListener(itowns.CONTROL_EVENTS.RANGE_CHANGED, () => {
                updateScaleWidget();
            });
*/
            // Draw a sphere to show where the 3D picking has been done
            function show3DPicking(x,y,z, iteration){

                var geometry = new itowns.THREE.SphereGeometry( 3, 16, 16 );
                var col = new itowns.THREE.Color(0XFFFF00);
                var material = new itowns.THREE.MeshBasicMaterial( {color: col.lerpHSL(new itowns.THREE.Color(0XFF0000), (iteration % 8) / 7), transparent:true, opacity:0.8} );
                var sphere = new itowns.THREE.Mesh( geometry, material );
                sphere.position.set(x,y,z); //console.log(sphere.position);
                sphere.updateMatrixWorld();
                globeView.scene.add( sphere );
                globeView.notifyChange();
            }
                        
        </script>
    </body>
</html>
